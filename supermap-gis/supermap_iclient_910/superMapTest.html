<!--********************************************************************
* Copyright© 2000 - 2018 SuperMap Software Co.Ltd. All rights reserved.
*********************************************************************-->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title data-i18n="resources.title_drawGeometry"></title>
    <style type="text/css">
    .editPane {
        position: absolute;
        left: 50px;
        top: 10px;
        text-align: center;
        background: #FFF;
        z-index: 1000;
    }
    </style>
</head>

<body style=" margin: 0;overflow: hidden;background: #fff;width: 100%;height:100%;position: absolute;top: 0;">
    <div class='panel panel-primary editPane' id='editPane' style="z-index: 99999">
        <div class='panel-heading'>
            <h5 class='panel-title text-center' data-i18n="resources.text_drawGeometry"></h5>
        </div>
        <div class='panel-body' id='params'>
            <p></p>
            <div align='right' class='button-group'>
                <input type='button' id='btn1' class='btn btn-primary' value="drawPoint(绘点)" onclick="draw_point()" />
                <input type='button' id='btn2' class='btn btn-primary' value="drawline(绘线)" onclick="draw_line()" />
                <input type='button' id='btn3' class='btn btn-primary' value="drawPolygon(绘面)" onclick="draw_polygon()" />
                <input type='button' id='btn4' class='btn btn-primary' value="select(选择)" onclick="selectFeature()" />
                <input type='button' id='btn5' class='btn btn-primary' value="modify(编辑)" onclick="modifyFeature()" />
                <input type='button' id='btn6' class='btn btn-primary' value='Undo(上一步)' onclick="undo()" />
                <input type='button' id='btn7' class='btn btn-primary' value='Redo(下一步)' onclick="redo()" />
                <input type='button' id='btn8' class='btn btn-primary' value="clear(清除)" onclick="clearFeatures()" />
                <input type='button' id='btn9' class='btn btn-primary' value="deactiveAll(取消操作)" onclick="deactiveAll()" />
                <input type='button' id='btn10' class='btn btn-primary' value="createLine(生成线)" onclick="draw_plotLine()" />
                <input type='button' id='btn10' class='btn btn-primary' value="createLine(生成线带轨迹)" onclick="draw_plotLine_1()" />
            </div>
        </div>
    </div>
    <div id="map" style="margin:0 auto;width: 100%;height: 100%"></div>
    <script type="text/javascript" include="bootstrap" src="examples/js/include-web.js"></script>
    <script type="text/javascript" exclude="iclient-classic"  src="dist/classic/include-classic.js"></script>
    <script type="text/javascript">
    //var host = window.isLocal ? window.server : "http://192.168.2.81:8091";
    //var map, url = host + "/iserver/services/map-JiaoTongDaXue/rest/maps/BJD";

    var host = window.isLocal ? window.server : "http://support.supermap.com.cn:8090",
        map, url = host + "/iserver/services/map-world/rest/maps/World";
    var mapName = "基础图层";
    var mapRESTLayer; //地图图层对象
    var mapCenterX = '116.33799'; //地图中心点X坐标
    var mapCenterY = '39.94879'; //地图中心点Y坐标
    var mapZoomLevel = 0; //地图展示等级，默认0

    var drawplotting;
    var plottingEdit;
    var plottingLayer;
    //用于渲染标号的图层var 
    var plotUrl = host + "/iserver/services/plot-jingyong/rest/plot/";


    var vecotrLayer; //矢量图层对象
    var VectorLayerName = "矢量图层";

    var markerStart; //标记覆盖物
    var markerEnd; //标记覆盖物
    var markerLayer; //标记图层对象
    var markerLayerName = "标记图层"
    var ObjStyle,size,offset;
	ObjStyle={
	    fillColor: "blue",
	    fillOpacity: 1,
	    hoverFillColor: "white",
	    hoverFillOpacity: 0.8,
	    strokeColor: "red",
	    strokeOpacity: 1,
	    strokeWidth: 3,
	    strokeLinecap: "round",
	    strokeDashstyle: "solid",
	    hoverStrokeColor: "red",
	    hoverStrokeOpacity: 1,
	    hoverStrokeWidth: 0.2,
	    pointRadius: 6,
	    hoverPointRadius: 1,
	    hoverPointUnit: "%",
	    pointerEvents: "visiblePainted",
	    cursor: "inherit",
	    fontColor: "#000000",
	    labelAlign: "cm",
	    labelOutlineColor: "white",
	    labelOutlineWidth: 3
	};

    var drawPoint; //画点要素
    var drawLine; //画线要素
    var drawPolygon; //画面要素

    var dragFeature; //鼠标拖拽要素

    var selectCtrl; //要素选择控件
    var modifyCtrl; //矢量要素编辑控件
    var animatorFeatures, animatorVector,
            peoStyle = {
                externalGraphic: 'examples/img/walk.png',
                allowRotate: false,
                graphicWidth: 20,
                graphicHeight: 20,
            };
	init();
    function init() {
        BrowserSupport(); //验证浏览器是否支持
        map = new SuperMap.Map("map", {
            controls: [
                new SuperMap.Control.Navigation({
                    dragPanOptions: {
                        enableKinetic: true
                    }
                }),
                new SuperMap.Control.Zoom(),
                new SuperMap.Control.LayerSwitcher()
            ]
        });
        vecotrLayer = new SuperMap.Layer.Vector(VectorLayerName);
        markerLayer = new SuperMap.Layer.Markers(markerLayerName);
        plottingLayer = new SuperMap.Layer.PlottingLayer("渲染标号", plotUrl);
        plottingLayer.style = {
            fillColor: "#66cccc",
            fillOpacity: 0.4,
            strokeColor: "#66cccc",
            strokeOpacity: 1,
            strokeWidth: 3,
            pointRadius: 6
        };
 

        drawplotting = new SuperMap.Control.DrawFeature(plottingLayer, SuperMap.Handler.GraphicObject);
        plottingEdit = new SuperMap.Control.PlottingEdit();
        map.addControls(plottingEdit);

        dragFeature = new SuperMap.Control.DragFeature(vecotrLayer);
        map.addControl(dragFeature);
        drawPoint = new SuperMap.Control.DrawFeature(vecotrLayer, SuperMap.Handler.Point, { multi: true });
        map.addControl(drawPoint);
        drawLine = new SuperMap.Control.DrawFeature(vecotrLayer, SuperMap.Handler.Path, { multi: true });
        map.addControl(drawLine);
        drawPolygon = new SuperMap.Control.DrawFeature(vecotrLayer, SuperMap.Handler.Polygon);
        drawPolygon.events.on({
            "featureadded": function(args) {
                console.log("添加要素（双击后马上执行该事件）--保存所绘信息的数据");
                //console.log(args);
                //var feature = args.feature;
                //var geometry = feature.geometry;
                var points = args.feature.geometry.getVertices();
                var points_str = "";
                //组装数据
                for (var i = 0; i < points.length; i++) {
                    var x = points[i].x;
                    var y = points[i].y;
                    points_str += x + "," + y;
                    if (i != points.length - 1) {
                        points_str += "|";
                    }
                }
                console.log("所绘图像Xy信息：" + points_str);
            },
            "beforefeatureadded": function(args) {
                console.log("创建要素（双击后，进行其他操作执行该事件）--保存所绘信息的数据");
                //console.log(args);
                //var feature = args.feature;
                //var geometry = feature.geometry;
                var points = args.feature.geometry.getVertices();
                var points_str = "";
                //组装数据
                for (var i = 0; i < points.length; i++) {
                    var x = points[i].x;
                    var y = points[i].y;
                    points_str += x + "," + y;
                    if (i != points.length - 1) {
                        points_str += "|";
                    }
                }
                console.log("所绘图像Xy信息：" + points_str);
            }
        });
        map.addControl(drawPolygon);
        modifyCtrl = new SuperMap.Control.ModifyFeature(vecotrLayer);
        map.addControl(modifyCtrl);
        selectCtrl = new SuperMap.Control.SelectFeature(vecotrLayer, {
            onSelect: function(feature) {
                //选中要素操作
                console.log("单击选中图层要素--打开查看详情弹窗");
            },
            onUnselect: function(feature) {
                //未选中要素操作
                console.log("单击选中图层非要素--关闭查看详情窗口");
            },
            callbacks: {
                dblclick: function(feature) {
                    //双击逻辑回调
                    console.log("selectCtrl--dblclick");
                }
            },
            hover: false,
            repeat: false
        });
        map.addControl(selectCtrl);
        //mapRESTLayer = new SuperMap.Layer.CloudLayer();
        mapRESTLayer = new SuperMap.Layer.TiledDynamicRESTLayer(mapName, url,
            null, { maxResolution: "auto", transparent: true, cacheEnabled: true });
        mapRESTLayer.events.on({ "layerInitialized": addLayer });
        //mapRESTLayer.events.on({"layerInitialized": addMarker});
        //初始化人物运动图层。
        animatorVector = new SuperMap.Layer.AnimatorVector("Peo", {}, {
            //设置速度为每帧播放0.003小时的数据
            speed: 0.1,
            //开始时间为0
            startTime: 0,
        });
    }

    //定义addLayer函数，触发 layerInitialized事件会调用此函数
    function addLayer() {
        // map.addLayers([mapRESTLayer]);//加载地图图层
        // map.addLayers([markerLayer]);//加载标记图层
        // map.addLayers([vecotrLayer]);//加载几何要素图层
        map.addLayers([mapRESTLayer, markerLayer, vecotrLayer, plottingLayer]);
        map.setCenter(new SuperMap.LonLat(0, 0), 0); //设置地图中心点，地图放大缩小等级

        var localDatas_1 = "48.605341246291,57.418397626113|113.76854599407,54.213649851632|70.504451038576,13.086053412463|43.26409495549,36.053412462908";
        var localDatas_2 = "18.160237388724,24.302670623145|55.548961424332,-2.4035608308605|18.160237388724,-17.359050445104";
        //线数据
        var line = new SuperMap.Geometry.LineString(datasToPointArray(localDatas_1));
        var line_feature = new SuperMap.Feature.Vector(line);
        line_feature.style = {
            fillColor: "red",
            fillOpacity: 0.4,
            strokeColor: "red",
            strokeOpacity: 1,
            strokeWidth: 3,
            pointRadius: 6
        };
        vecotrLayer.addFeatures(line_feature);


        //面数据
        var linearRing = new SuperMap.Geometry.LinearRing(datasToPointArray(localDatas_2));
        var polygon = new SuperMap.Geometry.Polygon([linearRing]);
        var polygon_feature = new SuperMap.Feature.Vector(polygon, { id: 1 }, null);
        vecotrLayer.addFeatures(polygon_feature);
    }
    //定义addMarker函数，触发layerInitialized事件会调用此函数
    function addMarker() {
        size = new SuperMap.Size(21, 21);
        offset = new SuperMap.Pixel(-(size.w / 2), -size.h);
        iconStart = new SuperMap.Icon('examples/img/start_trans.png', size, offset);
        iconEnd = new SuperMap.Icon('examples/img/end_trans.png', size, offset);
        //初始化标记覆盖物类
        markerStart = new SuperMap.Marker(new SuperMap.LonLat(116.3365804923, 39.950188670303), iconStart);
        markerEnd = new SuperMap.Marker(new SuperMap.LonLat(116.33703330103, 39.948717041941), iconEnd);
        //添加覆盖物到标记图层
        markerLayer.addMarker(markerStart);
        markerLayer.addMarker(markerEnd);
        //注册 click 事件,触发 mouseClickHandler()方法
        markerStart.events.on({
            "click": mouseClickHandler,
            "touchstart": mouseClickHandler //假如要在移动端的浏览器也实现点击弹框，则在注册touch类事件
        });
        markerEnd.events.on({
            "click": mouseClickHandler,
            "touchstart": mouseClickHandler //假如要在移动端的浏览器也实现点击弹框，则在注册touch类事件
        });
    }

    var infowin = null; //标记物的详情弹窗
    //定义mouseClickHandler函数，触发click事件会调用此函数
    function mouseClickHandler(event) {
        closeInfoWin();
        //初始化popup类
        popup = new SuperMap.Popup(
            "chicken",
            this.getLonLat(),
            new SuperMap.Size(220, 140),
            '详情...',
            true,
            null
        );

        infowin = popup;
        //添加弹窗到map图层
        map.addPopup(popup);
    }


    function closeInfoWin() {
        if (infowin) {
            try {
                infowin.hide();
                infowin.destroy();
            } catch (e) {}
        }
    }


    //数据解析，返回坐标点Array
    function datasToPointArray(localDatas) {
        var point_data = new Array();
        var points = new Array();
        var temp_Array = localDatas.split("|");
        for (var j = 0; j < temp_Array.length; j++) {
            var point = new Array();
            var t_x = temp_Array[j].split(",")[0];
            var t_y = temp_Array[j].split(",")[1];
            point.push(t_x);
            point.push(t_y);
            point_data.push(point);
            var sg_point = new SuperMap.Geometry.Point(t_x, t_y);
            points.push(sg_point);
        }
        return points;
    }

    //激活拖拽要素控件
    function activateDragFeature() {
        deactiveAll();
        dragFeature.activate();
    }
    //激活绘制点要素控件
    function draw_point() {
        deactiveAll();
        drawPoint.activate();
    }
    //激活绘制线要素控件
    function draw_line() {
        deactiveAll();
        drawLine.activate();
    }
    //激活绘制面要素控件
    function draw_polygon() {
        deactiveAll();
        drawPolygon.activate();
    }

    //激活选择要素控件
    function selectFeature() {
        deactiveAll();
        selectCtrl.activate();
    }
    //
    function modifyFeature() {
        deactiveAll();
        modifyCtrl.activate();
    }

    function undo() {
        modifyCtrl.undo();
    }

    function redo() {
        modifyCtrl.redo();
    }
    //注销所有要素控件
    function deactiveAll() {
        drawPoint.deactivate();
        drawLine.deactivate();
        drawPolygon.deactivate();
        selectCtrl.deactivate();
        modifyCtrl.deactivate();
        dragFeature.deactivate();
    }

    /**
     * 全部图层清除
     */
    function clearFeatures() {
        deactiveAll();
        vecotrLayer.removeAllFeatures();
        plottingLayer.removeAllFeatures();
        animatorVector.removeAllFeatures();
        markerLayer.destroy();
    }
    //点击生成线
    function draw_plotLine() {
        clearFeatures();
        var data_line = "130.86053412463,48.872403560831|197.09198813056,49.406528189911|144.74777448071,-7.7448071216617";

        plottingLayer.createSymbolWC(0, SuperMap.Plot.SymbolType.POLYLINESYMBOL, datasToPointArray(data_line)); //datasToPointArray(data_line)
    }

    /**
     * 根据给定坐标点画轨迹线
     * @param startPoint 数组对象
     * @param endPoint 数组对象
     * @param points 数组对象
     */
    function draw_plotLine_ByPoint(startPoint, endPoint, points) {
        clearFeatures();
        markerLayer = new SuperMap.Layer.Markers(markerLayerName);
        map.addLayers([markerLayer]);
        map.setCenter(new SuperMap.LonLat(startPoint[0], startPoint[1]), 0);
        markerLayer.addMarker(new SuperMap.Marker(new SuperMap.LonLat(startPoint[0], startPoint[1]), new SuperMap.Icon('examples/img/start_trans.png', new SuperMap.Size(21, 21), new SuperMap.Pixel(-(21 / 2), -21))));
        markerLayer.addMarker(new SuperMap.Marker(new SuperMap.LonLat(endPoint[0], endPoint[1]), new SuperMap.Icon('examples/img/end_trans.png', new SuperMap.Size(21, 21), new SuperMap.Pixel(-(21 / 2), -21))));
        var line_feature = new SuperMap.Feature.Vector(new SuperMap.Geometry.LineString(points));
        line_feature.style = ObjStyle;
        vecotrLayer.addFeatures(line_feature);
        animatorFeatures = [];
        var featureComps = line_feature.geometry.components;
        for (var k = 0, len = featureComps.length; k < len; k++) {
            var peo = new SuperMap.Feature.Vector(featureComps[k].clone(), {
                FEATUREID: line_feature.id,
                TIME: k
            }, peoStyle);
            animatorFeatures.push(peo);
        }
        animatorVector.addFeatures(animatorFeatures);
        animatorVector.animator.setEndTime(featureComps.length - 1);
        animatorVector.animator.start();
    }
    //点击生成线
    function draw_plotLine_1() {
        clearFeatures();
        var data_line = "130.86053412463,48.872403560831|197.09198813056,49.406528189911|144.74777448071,-7.7448071216617";
        var start = new Array;
        start.push('130.86053412463');
        start.push('49.406528189911');
        var end = new Array;
        end.push('144.74777448071');
        end.push('-7.7448071216617');
        draw_plotLine_ByPoint(start, end, datasToPointArray(data_line));
    }

    /**
     * 不支持
     * canvas的浏览器不能运行
     * android 设备也不能运行
     */
    function BrowserSupport() {
        // var broz = SuperMap.Util.getBrowser();
        // if (!document.createElement('canvas').getContext) {
        //     widgets.alert.showAlert(resources.msg_supportCanvas, false);
        //     return;
        // } else if (broz.device === 'android') {
        //     widgets.alert.showAlert(resources.msg_supportEquipment, false);
        //     return;
        // }
    }
    </script>
</body>

</html>