<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title data-i18n="resources.title_drawFeatures"></title>
    <script type="text/javascript" src="examples/js/include-web.js"></script>
</head>
<body style=" margin: 0;overflow: hidden;background: #fff;width: 100%;height:100%;position: absolute;top: 0;">
<div style="z-index: 999999;position: absolute;left: 50px;top: 10px;text-align: right;width: 800px;">
    <input type='button' id='btn1'  value="开始绘点" onclick="draw_point()"/>
    <input type='button' id='btn2'  value="开始绘线" onclick="draw_line()"/>
    <input type='button' id='btn3'  value="开始绘面" onclick="draw_polygon()"/>
    <input type='button' id='btn4'  value="选择"  onclick="selectFeature()"/>
    <input type='button' id='btn5'  value="开始编辑"  onclick="modifyFeature()"/>
    <input type='button' id='btn6'  value="返回上一步"  onclick="undo()"/>
    <input type='button' id='btn7'  value="返回下一步"  onclick="redo()"/>
    <input type='button' id='btn8'  value="全部清除"  onclick="clearFeatures()"/>
    <input type='button' id='btn9'  value="取消所有操作" onclick="deactiveAll()"/>
    <input type='button' id='btn10'  value="生成路线" onclick="draw_plotLine()"/>

</div>
<div id="map" style="width: 100%;height:100%;position:absolute;top:0px;left:0;background:#fff;"></div>
<script type="text/javascript" include="leaflet.draw" src="dist/classic/include-classic.js"></script>
<script type="text/javascript">
    var host = window.isLocal ? window.server : "http://192.168.2.81:8091";
    var map, url = host + "/iserver/services/map-JiaoTongDaXue/rest/maps/BJD";
    var mapName="基础图层";
    var mapRESTLayer;//地图图层对象
    var mapCenterX = '116.33799';//地图中心点X坐标
    var mapCenterY = '39.94879';//地图中心点Y坐标
    var mapZoomLevel = 0;//地图展示等级，默认0

	var drawplotting;
	var plottingEdit;
	var plottingLayer;
    //用于渲染标号的图层var 
    var plotUrl = host + "/iserver/services/plot-jingyong/rest/plot/";
    

    var vecotrLayer;//矢量图层对象
    var VectorLayerName="矢量图层";

   	var markerStart;//标记覆盖物
   	var markerEnd;//标记覆盖物
    var markerLayer;//标记图层对象
    var markerLayerName="标记图层"

    var drawPoint;//画点要素
    var drawLine;//画线要素
    var drawPolygon;//画面要素

    var dragFeature;//鼠标拖拽要素

    var selectCtrl;//要素选择控件
    var modifyCtrl;//矢量要素编辑控件

    map = new SuperMap.Map("map", {
        controls: [
        new SuperMap.Control.Navigation({
            dragPanOptions: {
                enableKinetic: true
            }
        }),
		new SuperMap.Control.Zoom(),
        new SuperMap.Control.LayerSwitcher()]
    });
	vecotrLayer = new SuperMap.Layer.Vector(VectorLayerName);
    markerLayer = new SuperMap.Layer.Markers(markerLayerName);
    plottingLayer = new SuperMap.Layer.PlottingLayer("渲染标号", plotUrl);
    plottingLayer.style = {
        fillColor: "#66cccc",
        fillOpacity: 0.4,
        strokeColor: "#66cccc",
        strokeOpacity: 1,
        strokeWidth: 3,
        pointRadius: 6
    };

    drawplotting = new SuperMap.Control.DrawFeature(plottingLayer, SuperMap.Handler.GraphicObject);
	plottingEdit = new SuperMap.Control.PlottingEdit();
    map.addControls(plottingEdit);

    dragFeature = new SuperMap.Control.DragFeature(vecotrLayer);
    map.addControl(dragFeature);
    drawPoint = new SuperMap.Control.DrawFeature(vecotrLayer, SuperMap.Handler.Point, {multi: true});
    map.addControl(drawPoint);
    drawLine = new SuperMap.Control.DrawFeature(vecotrLayer, SuperMap.Handler.Path, {multi: true});
    map.addControl(drawLine);
    drawPolygon = new SuperMap.Control.DrawFeature(vecotrLayer, SuperMap.Handler.Polygon);
    drawPolygon.events.on({
        "featureadded": function (args) {
			console.log("添加要素（双击后马上执行该事件）--保存所绘信息的数据");
			//console.log(args);
			//var feature = args.feature;
            //var geometry = feature.geometry;
            var points = args.feature.geometry.getVertices();
            var points_str = "";
            //组装数据
            for (var i = 0; i < points.length; i++) {
                var x = points[i].x;
                var y = points[i].y;
                points_str += x + "," + y;
                if (i != points.length - 1) {
                    points_str += "|";
                }
            }
            console.log("所绘图像Xy信息："+points_str);
        },
         "beforefeatureadded": function (args) {
			console.log("创建要素（双击后，进行其他操作执行该事件）--保存所绘信息的数据");
			//console.log(args);
			//var feature = args.feature;
            //var geometry = feature.geometry;
            var points = args.feature.geometry.getVertices();
            var points_str = "";
            //组装数据
            for (var i = 0; i < points.length; i++) {
                var x = points[i].x;
                var y = points[i].y;
                points_str += x + "," + y;
                if (i != points.length - 1) {
                    points_str += "|";
                }
            }
            console.log("所绘图像Xy信息："+points_str);
        }
    });
    map.addControl(drawPolygon);
    modifyCtrl = new SuperMap.Control.ModifyFeature(vecotrLayer);
    map.addControl(modifyCtrl);
    selectCtrl = new SuperMap.Control.SelectFeature(vecotrLayer, {
        onSelect: function (feature) {
            //选中要素操作
			console.log("单击选中图层要素--打开查看详情弹窗");
        },
        onUnselect: function (feature) {
            //未选中要素操作
			console.log("单击选中图层非要素--关闭查看详情窗口");
        },
        callbacks: {
            dblclick: function (feature) {
                //双击逻辑回调
			console.log("selectCtrl--dblclick");
            }
        },
        hover: false,
        repeat: false
    });
    map.addControl(selectCtrl);


    
    mapRESTLayer = new SuperMap.Layer.TiledDynamicRESTLayer(mapName, url,
                    null, {maxResolution: "auto", transparent: true, cacheEnabled: true});
	mapRESTLayer.events.on({"layerInitialized": addLayer});
	mapRESTLayer.events.on({"layerInitialized": addMarker});



    //定义addLayer函数，触发 layerInitialized事件会调用此函数
	function addLayer(){
	    // map.addLayers([mapRESTLayer]);//加载地图图层
	    // map.addLayers([markerLayer]);//加载标记图层
	    // map.addLayers([vecotrLayer]);//加载几何要素图层
	    map.addLayers([mapRESTLayer, markerLayer, vecotrLayer,plottingLayer]);
	    map.setCenter(new SuperMap.LonLat(116.34, 39.95), 0);//设置地图中心点，地图放大缩小等级

		var localDatas_1="116.3365804923,39.950188670303|116.33807098769,39.950471675757|116.33850492939,39.949132116607|116.34035389835,39.949471723152|116.34018409508,39.950075468121|116.34099537738,39.950207537333|116.34127838284,39.949622659394|116.34101424441,39.949603792364|116.34110857957,39.949245318789|116.34044823351,39.949169850668|116.34035389835,39.949452856122|116.33792005145,39.949018914425|116.33795778551,39.948849111153|116.33703330103,39.948717041941";
		var localDatas_2="116.3353674164,39.954024720796|116.33895088874,39.953997978465|116.33758702987,39.952019045981|116.33598249001,39.952446923275|116.33480582746,39.952152757635|116.33381636121,39.952981769892|116.33317454527,39.954131690119";
        //线数据
        var line = new SuperMap.Geometry.LineString(datasToPointArray(localDatas_1));
        var line_feature = new SuperMap.Feature.Vector(line);
        line_feature.style = {
	        fillColor: "red",
	        fillOpacity: 0.4,
	        strokeColor: "red",
	        strokeOpacity: 1,
	        strokeWidth: 3,
	        pointRadius: 6
	    };
        vecotrLayer.addFeatures(line_feature);


        //面数据
	    var linearRing = new SuperMap.Geometry.LinearRing(datasToPointArray(localDatas_2));
	    var polygon = new SuperMap.Geometry.Polygon([linearRing]);
	    var polygon_feature = new SuperMap.Feature.Vector(polygon, {id: 1}, null);
	    vecotrLayer.addFeatures(polygon_feature);
	}
	//定义addMarker函数，触发layerInitialized事件会调用此函数
    function addMarker() {
        size = new SuperMap.Size(21, 21);
        offset = new SuperMap.Pixel(-(size.w / 2), -size.h);
        iconStart = new SuperMap.Icon('examples/img/start_trans.png', size, offset);
        iconEnd = new SuperMap.Icon('examples/img/end_trans.png', size, offset);
        //初始化标记覆盖物类
        markerStart = new SuperMap.Marker(new SuperMap.LonLat(116.3365804923,39.950188670303), iconStart);
        markerEnd = new SuperMap.Marker(new SuperMap.LonLat(116.33703330103,39.948717041941), iconEnd);
        //添加覆盖物到标记图层
        markerLayer.addMarker(markerStart);
        markerLayer.addMarker(markerEnd);
        //注册 click 事件,触发 mouseClickHandler()方法
        markerStart.events.on({
            "click": mouseClickHandler,
            "touchstart": mouseClickHandler     //假如要在移动端的浏览器也实现点击弹框，则在注册touch类事件
        });
        markerEnd.events.on({
            "click": mouseClickHandler,
            "touchstart": mouseClickHandler     //假如要在移动端的浏览器也实现点击弹框，则在注册touch类事件
        });
    }

    var infowin = null;//标记物的详情弹窗
    //定义mouseClickHandler函数，触发click事件会调用此函数
    function mouseClickHandler(event) {
        closeInfoWin();
        //初始化popup类
        popup = new SuperMap.Popup(
            "chicken",
            this.getLonLat(),
            new SuperMap.Size(220, 140),
            '详情...',
            true,
            null
        );

        infowin = popup;
        //添加弹窗到map图层
        map.addPopup(popup);
    }


    function closeInfoWin() {
        if (infowin) {
            try {
                infowin.hide();
                infowin.destroy();
            }
            catch (e) {
            }
        }
    }


	//数据解析，返回坐标点Array
	function datasToPointArray(localDatas){
		var point_data = new Array();
        var points = new Array();
        var temp_Array = localDatas.split("|");
        for (var j = 0; j < temp_Array.length; j++) {
            var point = new Array();
            var t_x = temp_Array[j].split(",")[0];
            var t_y = temp_Array[j].split(",")[1];
            point.push(t_x);
            point.push(t_y);
            point_data.push(point);
            var sg_point = new SuperMap.Geometry.Point(t_x,t_y);
            points.push(sg_point);
        }
        return points;
	}

     //激活拖拽要素控件
    function activateDragFeature() {
        deactiveAll();
        dragFeature.activate();
    }
	//激活绘制点要素控件
	function draw_point() {
        deactiveAll();
        drawPoint.activate();
    }
	//激活绘制线要素控件
    function draw_line() {
        deactiveAll();
        drawLine.activate();
    }
	//激活绘制面要素控件
    function draw_polygon() {
        deactiveAll();
        drawPolygon.activate();
    }
	
    //激活选择要素控件
    function selectFeature() {
        deactiveAll();
        selectCtrl.activate();
    }
    //
    function modifyFeature() {
        deactiveAll();
        modifyCtrl.activate();
    }

    function undo() {
        modifyCtrl.undo();
    }

    function redo() {
        modifyCtrl.redo();
    }
	//注销所有要素控件
    function deactiveAll() {
        drawPoint.deactivate();
        drawLine.deactivate();
        drawPolygon.deactivate();
        selectCtrl.deactivate();
        modifyCtrl.deactivate();
        dragFeature.deactivate();
    }
    function clearFeatures() {
        deactiveAll();
        vecotrLayer.removeAllFeatures();
        plottingLayer.removeAllFeatures();
    }
    //点击生成线
    function draw_plotLine() {
        clearFeatures();
        var data_line ="116.33051270782,39.949971610037|116.33215932565,39.950255509664|116.33247161524,39.949205081046|116.33335170408,39.949403810785|116.33312458438,39.950454239402|116.33397628326,39.950709749066|116.33383433345,39.95119237843";

        plottingLayer.createSymbolWC(0, SuperMap.Plot.SymbolType.POLYLINESYMBOL, datasToPointArray(data_line));//datasToPointArray(data_line)
    }
    vecotrLayer.style = {
        fillColor: "blue",
        fillOpacity: 1,
        hoverFillColor: "white",
        hoverFillOpacity: 0.8,
        strokeColor: "#ee9900",
        strokeOpacity: 1,
        strokeWidth: 1,
        strokeLinecap: "round",
        strokeDashstyle: "solid",
        hoverStrokeColor: "red",
        hoverStrokeOpacity: 1,
        hoverStrokeWidth: 0.2,
        pointRadius: 6,
        hoverPointRadius: 1,
        hoverPointUnit: "%",
        pointerEvents: "visiblePainted",
        cursor: "inherit",
        fontColor: "#000000",
        labelAlign: "cm",
        labelOutlineColor: "white",
        labelOutlineWidth: 3
    };
</script>
</body>
</html>